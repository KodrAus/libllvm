# pr: none

jobs:

# Fetch llvm source
# We do this once so all subsequent steps
# have a consistent source to work off
- job: Setup
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  # Get the commit hash we intend to build
  - script: ci/llvm-src.sh

  # Publish the hash as an artifact
  - script: mkdir llvm-src-tmp
  - script: mv llvm-commit llvm-src-tmp
  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: 'llvm-commit'
      targetPath: 'llvm-src-tmp'

# linux-x64 build of LLVM
- job: Linux
  timeoutInMinutes: 360
  pool:
    vmImage: 'ubuntu-16.04'
  dependsOn:
  - Setup
  steps:
  # Fetch the temp artifacts for the build
  - task: DownloadPipelineArtifact@0
    inputs:
      artifactName: 'llvm-commit'
      targetPath: $(System.DefaultWorkingDirectory)/llvm-src-tmp
  - script: mv llvm-src-tmp/* .
  - script: rm -r llvm-src-tmp

  # Build libLLVM.so
  - script: ci/linux-x64.sh

  # Add the Linux build artifacts
  - script: mkdir llvm-linux-x64-tmp
  - script: cp llvm-linux-x64/lib/libLLVM.so llvm-linux-x64-tmp
  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: 'llvm-linux-x64'
      targetPath: 'llvm-linux-x64-tmp'

# osx-x64 build of LLVM
- job: macOS
  timeoutInMinutes: 360
  pool:
    vmImage: 'macOS-10.13'
  dependsOn:
  - Setup
  steps:
  # Fetch the temp artifacts for the build
  - task: DownloadPipelineArtifact@0
    inputs:
      artifactName: 'llvm-commit'
      targetPath: $(System.DefaultWorkingDirectory)/llvm-src-tmp
  - script: mv llvm-src-tmp/* .
  - script: rm -r llvm-src-tmp

  # Build libLLVM.dylib
  - script: ci/osx-x64.sh

  # Add the OSX build artifacts
  - script: mkdir llvm-osx-x64-tmp
  - script: cp llvm-osx-x64/lib/libLLVM.dylib llvm-osx-x64-tmp
  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: 'llvm-osx-x64'
      targetPath: 'llvm-osx-x64-tmp'

# win81-x64 build of LLVM
- job: Windows
  timeoutInMinutes: 360
  pool:
    vmImage: 'vs2017-win2016'
  dependsOn:
  - Setup
  steps:
  # Fetch the temp artifacts for the build
  - task: DownloadPipelineArtifact@0
    inputs:
      artifactName: 'llvm-commit'
      targetPath: $(System.DefaultWorkingDirectory)/llvm-src-tmp
  - script: mv llvm-src-tmp/* .
  - script: rm -r llvm-src-tmp

  # Build LLVM.dll
  - powershell: ci/win81-x64.ps1

  # Add the Windows build artifacts
  # - script: mkdir llvm-win81-x64-tmp
  # - script: cp llvm-win81-x64/lib/LLVM.dll llvm-win81-x64-tmp
  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: 'llvm-win81-x64'
      # targetPath: 'llvm-win81-x64-tmp'
      targetPath: 'llvm-win81-x64/lib'

# Package the artifacts into a single nupkg
- job: Package
  pool:
    vmImage: 'vs2017-win2016'
  dependsOn:
  - Linux
  - macOS
  - Windows
  steps:
  - task: DownloadPipelineArtifact@0
    inputs:
      artifactName: 'llvm-linux-x64'
      targetPath: $(System.DefaultWorkingDirectory)/llvm-linux-x64
  - task: DownloadPipelineArtifact@0
    inputs:
      artifactName: 'llvm-osx-x64'
      targetPath: $(System.DefaultWorkingDirectory)/llvm-osx-x64
  - script: ls